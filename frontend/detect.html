<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Space Station</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html { height: 100%; margin: 0; }
    .background {
      background: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/ed5f9f3e-6c5e-4682-9405-3c8e34aac29a.png') no-repeat center center/cover;
      position: fixed; width: 100%; height: 100%;
      filter: brightness(0.5); z-index: -1;
    }
    .nav-home { background-color: #5f5e41; }
    .nav-detect { background-color: #3f1d18; }
    .nav-about { background-color: #67634f; }
    .nav-contact { background-color: #3f1d18; }
    .btn-start {
      background-color: white; color: black;
      border-radius: 10px; padding: 12px 30px; font-size: 1.25rem; font-weight: 600;
      border: 1px solid black; box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
      cursor: pointer; user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      text-decoration: none;
    }
    .btn-start:hover {
      background-color: #f0ead6; color: #331500; border-color: #331500;
    }
    .preview-container {
      display: none; gap: 2rem; margin-bottom: 0.5rem;
      justify-content: center; align-items: stretch;
    }
    .show-preview { display: flex !important; }
    .preview-box {
      background: rgba(30,30,40,0.65); border-radius: 1rem;
      padding: 1.25rem 1rem 0.75rem 1rem; box-shadow: 0 2px 18px 0 rgba(0,0,0,0.35);
      min-width: 230px; min-height: 210px; display: flex; flex-direction: column; align-items: center;
      backdrop-filter: blur(3px);
    }
    .preview-label { color: #fafafa; font-weight: 700; font-family: ui-sans-serif, system-ui, sans-serif; margin-bottom: 0.5rem; letter-spacing: 1px;}
    .dark-img-bg { min-width: 190px; min-height: 150px; background: #2228; object-fit: contain; border-radius: 0.5rem; margin-bottom: 0.5rem; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.30); display: none;}
    .dark-img-bg.shown { display: block !important; }
  </style>
</head>
<body class="relative min-h-screen flex flex-col">
  <div class="background" role="img" aria-label="Space station above Earth with starry sky and a spaceship flying by"></div>
  <!-- Navigation Bar -->
  <nav class="w-full flex justify-center space-x-2 mt-4 text-white font-sans tracking-wide">
    <a href="Home.html" class="nav-home px-5 py-3 rounded-md hover:opacity-80 transition-opacity">HOME</a>
    <a href="detect.html" class="nav-detect px-5 py-3 rounded-md hover:opacity-80 transition-opacity">DETECT</a>
    <a href="about.html" class="nav-about px-5 py-3 rounded-md hover:opacity-80 transition-opacity">ABOUT US</a>
    <a href="helpus.html" class="nav-about px-5 py-3 rounded-md hover:opacity-80 transition-opacity">HELP US</a>
  </nav>
  <!-- Content central container -->
  <main class="flex-grow flex flex-col justify-center items-center text-center px-4">
    <h1 class="text-5xl md:text-7xl font-serif text-cream leading-tight mb-12 text-yellow-50 drop-shadow-lg">
      Welcome
    </h1>
    <div class="flex flex-col items-center space-y-2 w-full max-w-md mb-6">
      <!-- Parallel buttons for file or camera -->
      <div class="flex space-x-4 mb-2">
        <button type="button" id="cameraBtn" class="btn-start">Use Camera</button>
        <label for="imageInput" class="btn-start cursor-pointer">Choose File</label>
        <input type="file" id="imageInput" name="file" accept="image/*" class="hidden" />
      </div>
      <!-- Camera preview (hidden initially) -->
      <div id="cameraContainer" style="display: none;" class="flex flex-col items-center">
        <video id="player" class="mb-3 w-80 h-64 bg-black rounded" autoplay playsinline></video>
        <button type="button" id="capture" class="btn-start mb-2">Capture</button>
        <button type="button" id="closeCamera" class="btn-start mb-2">Close</button>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>
      <div id="imageStatus" class="mb-2 text-green-300 font-semibold"></div>
      <!-- PARALLEL IMAGE DISPLAY: BEFORE AND AFTER, INITIALLY HIDDEN -->
      <div id="mainPreviewContainer" class="preview-container">
        <div class="preview-box">
          <span class="preview-label">Original</span>
          <img id="imagePreview" src="" alt="Image Preview" class="dark-img-bg" />
        </div>
        <div class="preview-box">
          <span class="preview-label">Detected</span>
          <img id="processedPreview" src="" alt="Detection Result" class="dark-img-bg" />
        </div>
      </div>
    </div>
    <!-- Detect form + Results -->
    <form id="uploadForm" enctype="multipart/form-data" class="flex flex-col items-center space-y-3">
      <button type="submit" class="btn-start">DETECT NOW</button>
    </form>
    <div id="result" class="mt-6 text-white text-lg"></div>
  </main>
  <script>
const cameraBtn = document.getElementById('cameraBtn');
const cameraContainer = document.getElementById('cameraContainer');
const player = document.getElementById('player');
const canvas = document.getElementById('canvas');
const captureButton = document.getElementById('capture');
const closeCameraButton = document.getElementById('closeCamera');
const fileInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const processedPreview = document.getElementById('processedPreview');
const mainPreviewContainer = document.getElementById('mainPreviewContainer');
let stream = null;

// Camera logic
cameraBtn.addEventListener('click', async () => {
  cameraContainer.style.display = 'flex';
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    player.srcObject = stream;
  } catch (e) {
    alert("Camera access denied or unavailable.");
    cameraContainer.style.display = 'none';
  }
});
function closeCamera() {
  cameraContainer.style.display = 'none';
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  player.srcObject = null;
}
closeCameraButton.addEventListener('click', closeCamera);

captureButton.addEventListener('click', () => {
  canvas.width = player.videoWidth;
  canvas.height = player.videoHeight;
  canvas.getContext('2d').drawImage(player, 0, 0);
  canvas.toBlob(function(blob) {
    const file = new File([blob], "capture.jpg", {type: 'image/jpeg'});
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
    document.getElementById('imageStatus').innerText = "Image captured ✅";
    showPreview(file);
  }, 'image/jpeg');
  closeCamera();
});

// Preview logic
fileInput.addEventListener('change', () => {
  if (fileInput.files.length > 0) {
    document.getElementById('imageStatus').innerText = "Image uploaded ✅";
    showPreview(fileInput.files[0]);
  } else {
    document.getElementById('imageStatus').innerText = "";
    showPreview(null);
  }
});

function showPreview(file) {
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      imagePreview.src = e.target.result;
      imagePreview.classList.add("shown");
      updatePreviewContainer();
    };
    reader.readAsDataURL(file);
  } else {
    imagePreview.src = "";
    imagePreview.classList.remove("shown");
    updatePreviewContainer();
  }
}

// Show/hide the whole preview box based on contents
function updatePreviewContainer() {
  if (imagePreview.src && imagePreview.classList.contains("shown") || processedPreview.src && processedPreview.classList.contains("shown")) {
    mainPreviewContainer.classList.add("show-preview");
  } else {
    mainPreviewContainer.classList.remove("show-preview");
  }
}

// Accessibility: Read results aloud
function speakResults(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }
}

// Submit logic
document.getElementById("uploadForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  processedPreview.style.display = "none";
  processedPreview.classList.remove("shown");
  processedPreview.src = "";
  updatePreviewContainer();
  document.getElementById("result").innerHTML = "";
  if (!fileInput.files.length) return;
  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  document.getElementById("result").innerHTML = "<em>Processing image...</em>";
  try {
    const response = await fetch("http://localhost:8000/predict/", { method: "POST", body: formData });
    const data = await response.json();
    let resultText = '';
    if (data.detections && data.detections.length > 0) {
      document.getElementById("result").innerHTML =
        "<strong>Detections:</strong><ul>" +
        data.detections.map(det => `<li>${det.label} (${(det.confidence * 100).toFixed(1)}%)</li>`).join("") +
        "</ul>";
      resultText = data.detections.map(
         det => `${det.label}, confidence ${(det.confidence * 100).toFixed(0)} percent`
      ).join('. ');
      // Show processed image if exists
      if (data.result_img_url) {
        processedPreview.src = 'http://localhost:8000' + data.result_img_url;
        processedPreview.style.display = "block";
        processedPreview.classList.add("shown");
        updatePreviewContainer();
      }
    } else if (data.error) {
      document.getElementById("result").innerHTML =
        `<span style="color:red;">Backend Error: ${data.error}</span>`;
      resultText = "Backend error.";
      processedPreview.style.display = "none";
      processedPreview.classList.remove("shown");
      updatePreviewContainer();
    } else {
      document.getElementById("result").innerHTML = "<span>No objects detected.</span>";
      resultText = "No objects detected.";
      processedPreview.style.display = "none";
      processedPreview.classList.remove("shown");
      updatePreviewContainer();
    }
    // Speak results aloud for accessibility
    speakResults(resultText);
  } catch (err) {
    document.getElementById("result").innerHTML =
      "<span style='color: red;'>Error: " + err.message + "</span>";
    speakResults("An error occurred while processing.");
    processedPreview.style.display = "none";
    processedPreview.classList.remove("shown");
    updatePreviewContainer();
  }
});

// Ensure "Detected" is hidden on page load
processedPreview.style.display = "none";
processedPreview.classList.remove("shown");
imagePreview.classList.remove("shown");
updatePreviewContainer();
  </script>
</body>
</html>
